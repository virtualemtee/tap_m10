<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line 1 Tapping Report</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Link to Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @media print {
            th:nth-child(12), td:nth-child(12) { display: none; }
            .navigation { display: none; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { padding: 5px; border: 1px solid #000; }
        }
        .loader {
            display: none;
            position: relative;
            margin-left: 10px;
            align-items: center;
            font-size: 14px;
        }
        .loader .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .editable {
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Navigation Buttons -->
    <div class="navigation">
        <a href="maps.html"><button id="cell-lines-btn">Tapping Card</button></a>
        <a href="line1.html"><button id="line-1-btn" class="active">Line 1</button></a>
        <a href="line2.html"><button id="line-2-btn">Line 2</button></a>
        <button id="print-btn">Print</button>
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <span>Updating Table...</span>
        </div>
    </div>

    <h1>Line 1 Tapping Report</h1>

    <!-- Line Data Table -->
    <table id="line-1-table" class="data-table" border="1">
        <thead>
            <tr>
                <th>SN</th>
                <th>Timestamp</th>
                <th>Badge No.</th>
                <th>Line</th>
                <th>Room</th>
                <th>Cruce Number</th>
                <th>Shift</th>
                <th>Pots Tapped</th>
                <th>Call Weight</th>
                <th>Gross Weight</th>
                <th>Tare Weight</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Line data will be dynamically added here -->
        </tbody>
    </table>

    <script type="module">
        // Firebase modules import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_IIpwfpdoSKiNTtIeglpONUhcWD88YpA",
            authDomain: "goiper.firebaseapp.com",
            databaseURL: "https://goiper-default-rtdb.firebaseio.com",
            projectId: "goiper",
            storageBucket: "goiper.appspot.com",
            messagingSenderId: "1037467961454",
            appId: "1:1037467961454:web:cf9b174e7ffd0db5f83e7f",
            measurementId: "G-MD5S9TBHLC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Helper function to get the date from URL
        function getDateFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('date') || '';  // Fallback to empty string if no date
        }

        // Load data from Firebase
        function loadData(line, date) {
            const dbRef = ref(database, `${date}/`); // Firebase node path based on date
            const loader = document.getElementById('loader');
            const tableBody = document.querySelector('#line-1-table tbody');
            
            loader.style.display = 'flex';  // Show loader while fetching data

            console.log(`Fetching data from path: ${date}/`);
            
            onValue(dbRef, (snapshot) => {
                if (snapshot.exists()) {
                    const rows = [];  // Array to hold table rows
                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        console.log('Data Snapshot:', data); // Log data

                        if (data.line === line) {
                            rows.push({
                                ...data,
                                id: childSnapshot.key,
                                formattedDate: formatDate(new Date(data.timestamp)),
                            });
                        }
                    });

                    // Clear table and repopulate it with data
                    tableBody.innerHTML = '';  
                    if (rows.length) {
                        rows.forEach((row, index) => {
                            const rowHTML = createRow(row, index + 1);
                            tableBody.insertAdjacentHTML('beforeend', rowHTML);
                        });
                        attachListeners();  // Attach edit/delete event listeners
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="12">No data for selected date.</td></tr>`;
                    }
                } else {
                    tableBody.innerHTML = `<tr><td colspan="12">No data available.</td></tr>`;
                }
                loader.style.display = 'none';  // Hide loader
            }, (error) => {
                console.error('Error fetching data:', error);
                loader.style.display = 'none';  // Hide loader on error
            });
        }

        // Helper function to format date
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Function to create table row HTML
        function createRow(row, index) {
            return `
                <tr data-id="${row.id}">
                    <td>${index}</td>
                    <td>${row.formattedDate}</td>
                    <td>${row.badgeNo || ''}</td>
                    <td>${row.line}</td>
                    <td>${row.room || ''}</td>
                    <td>${row.selectedCruce || ''}</td>
                    <td>${row.selectedShift || ''}</td>
                    <td>${row.potsTapped || 'No pots tapped'}</td>
                    <td>${row.callWeight || ''}</td>
                    <td><span class="editable">${row.grossWeight || ''}</span></td>
                    <td><span class="editable">${row.tareWeight || ''}</span></td>
                    <td>
                        <i class="fas fa-edit edit-btn" title="Edit"></i>
                        <i class="fas fa-trash delete-btn" title="Delete"></i>
                    </td>
                </tr>
            `;
        }

        // Attach edit and delete event listeners
        function attachListeners() {
            document.querySelectorAll('.edit-btn').forEach((editBtn) => {
                editBtn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const grossWeight = row.querySelector('td:nth-child(10) span');
                    const tareWeight = row.querySelector('td:nth-child(11) span');
                    const isEditing = this.classList.contains('fa-save');
                    const rowId = row.getAttribute('data-id');

                    if (isEditing) {
                        // Save data to Firebase
                        update(ref(database, `${getDateFromURL()}/${rowId}`), {
                            grossWeight: grossWeight.textContent,
                            tareWeight: tareWeight.textContent
                        });
                        grossWeight.contentEditable = false;
                        tareWeight.contentEditable = false;
                        this.classList.remove('fa-save');
                        this.classList.add('fa-edit');
                    } else {
                        // Enable editing
                        grossWeight.contentEditable = true;
                        tareWeight.contentEditable = true;
                        this.classList.remove('fa-edit');
                        this.classList.add('fa-save');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach((deleteBtn) => {
                deleteBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this entry?')) {
                        const rowId = this.closest('tr').getAttribute('data-id');
                        remove(ref(database, `${getDateFromURL()}/${rowId}`));
                        this.closest('tr').remove();  // Remove the row from the table
                    }
                });
            });
        }

        // Load data when the page is ready
        document.addEventListener('DOMContentLoaded', () => {
            const date = getDateFromURL();
            loadData('1', date);  // Load data for Line 1
        });

        // Print button functionality
        document.getElementById('print-btn').addEventListener('click', () => {
            window.print();
        });
    </script>
</body>
</html>
