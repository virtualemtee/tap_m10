<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line 2 Tapping Report</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Link to Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Print-specific styles */
        @media print {
            /* Hide the Actions column */
            th:nth-child(12), /* Header cell */
            td:nth-child(12) { /* Data cells */
                display: none;
            }
            /* Hide navigation buttons */
            .navigation {
                display: none;
            }
            /* Ensure the table takes the full width */
            table {
                width: 100%;
                border-collapse: collapse; /* Ensure borders are collapsed */
                font-size: 12px; /* Adjust font size for printing */
            }
            th, td {
                white-space: nowrap; /* Prevent text wrapping */
                overflow: hidden; /* Hide overflow text */
                text-overflow: ellipsis; /* Add ellipsis for overflowing text */
                padding: 5px; /* Add some padding */
                border: 1px solid #000; /* Add border for better visibility */
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Buttons -->
    <div class="navigation">
        <a href="index.html">
            <button id="cell-lines-btn">Tapping Card</button>
        </a>
        <a href="line1.html">
            <button id="line-1-btn" class="active">Line 1</button>
        </a>
        <a href="line2.html">
            <button id="line-2-btn" >Line 2</button>
        </a>
        <button id="print-btn">Print</button>
    </div>

    <h1>Line 2 Tapping Report</h1>

    <!-- Line 2 Data Table -->
    <table id="line-2-table" class="data-table" border="1">
        <thead>
            <tr>
                <th>SN</th>
                <th>Timestamp</th>
                <th>Badge No.</th>
                <th>Line</th>
                <th>Room</th>
                <th>Cruce Number</th>
                <th>Shift</th>
                <th>Pots Tapped</th>
                <th>Call Weight</th>
                <th>Gross Weight</th>
                <th>Tare Weight</th>
                <th>Actions</th> <!-- This column will be hidden during printing -->
            </tr>
        </thead>
        <tbody>
            <!-- Line 2 data will be dynamically added here -->
        </tbody>
    </table>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_IIpwfpdoSKiNTtIeglpONUhcWD88YpA",
            authDomain: "goiper.firebaseapp.com",
            databaseURL: "https://goiper-default-rtdb.firebaseio.com",
            projectId: "goiper",
            storageBucket: "goiper.appspot.com",
            messagingSenderId: "1037467961454",
            appId: "1:1037467961454:web:cf9b174e7ffd0db5f83e7f",
            measurementId: "G-MD5S9TBHLC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Function to get the date from the URL
        function getDateFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('date'); // Get the 'date' parameter from the URL
        }

        // Function to load data from Firebase based on the selected line and date
        function loadData(selectedLine, date) {
            const dbRef = ref(database, `${date}/`);  // Firebase reference based on the date
            const line1TableBody = document.querySelector('#line-2-table tbody');

            get(dbRef).then((snapshot) => {
                if (snapshot.exists()) {
                    line1TableBody.innerHTML = ''; // Clear any previous rows
                    let index = 1; // Initialize serial number index

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();

                        // Check if the data belongs to the selected line (Line 2)
                        if (data.line === selectedLine) {
                            // Format the date and time to dd/mm/yyyy and hh:mm (24-hour format)
                            const date = new Date(data.timestamp);
                            const formattedDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                            const formattedTime = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                            const rowHTML = `
                                <tr>
                                    <td>${index}</td>
                                    <td>${formattedDate} ${formattedTime}</td> <!-- Combined date and time -->
                                    <td>${data.badgeNo}</td>
                                    <td>${data.line}</td>
                                    <td>${data.room}</td>
                                    <td>${data.cruceNumber}</td>
                                    <td>${data.selectedShift || ''}</td>
                                    <td>${data.potsTapped.join(', ')}</td>
                                    <td>${data.callWeight}</td>
                                    <td>${data.grossWeight}</td>
                                    <td>${data.tareWeight}</td>
                                    <td>
                                        <i class="fas fa-edit edit-btn" data-id="${childSnapshot.key}" title="Edit"></i>
                                        <i class="fas fa-trash delete-btn" data-id="${childSnapshot.key}" title="Delete"></i>
                                    </td>
                                </tr>
                            `;

                            // Append the new row to the table
                            line1TableBody.insertAdjacentHTML('beforeend', rowHTML);
                            index++; // Increment the serial number index
                        }
                    });
                } else {
                    console.log("No data available for the selected date.");
                }
            }).catch((error) => {
                console.error("Error loading data: ", error);
            });
        }

        // Load Line 2 data when the page loads, using the date from the URL
        document.addEventListener('DOMContentLoaded', () => {
            const date = getDateFromURL();  // Get the date from the URL
            if (date) {
                loadData("1", date);  // Load data for Line 2 based on the selected date
            } else {
                console.error("No date parameter found in the URL.");
            }
        });

        // Refresh the data every 10 seconds without clearing the table
        setInterval(() => {
            const date = getDateFromURL();
            if (date) {
                loadData("2", date);  // Refresh data for Line 2 based on the selected date
            }
        }, 10000);  // 10000 milliseconds = 10 seconds

        // Print report function
        document.getElementById('print-btn').addEventListener('click', function() {
            window.print(); // Opens print dialog
        });
    </script>
</body>
</html>
